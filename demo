from django.utils import timezone
from django.db import transaction

def sync_users(self):
    try:
        wordpress_users = self.get_users_from_service()
        existing_emails = [user['user_email'] for user in wordpress_users]
        count_users = len(existing_emails)
        logger.info(f"Count : {count_users}")

        if count_users == 0:
            logger.warning("No users found. Skipping cost per user calculation.")
            cost_per_user = 0
        else:
            cost_per_user = 300 / count_users

        # Deactivate users not in WordPress list
        PermissionMapper.objects.filter(
            service=self.service
        ).exclude(
            employee__email__in=existing_emails
        ).update(
            active=False,
            deactivate_time=timezone.now()
        )

        # Prepare employees to bulk create/update
        employees_to_create = []
        employees_to_update = []
        existing_employees = {
            e.email: e for e in Employee.objects.filter(email__in=existing_emails)
        }

        for user in wordpress_users:
            email = user['user_email']
            display_name = user['display_name']

            if email in existing_employees:
                emp = existing_employees[email]
                emp.display_name = display_name
                employees_to_update.append(emp)
            else:
                employees_to_create.append(Employee(email=email, display_name=display_name))

        # Bulk operations (all inside transaction for safety)
        with transaction.atomic():
            if employees_to_create:
                Employee.objects.bulk_create(employees_to_create, batch_size=500)

            if employees_to_update:
                Employee.objects.bulk_update(employees_to_update, ['display_name'], batch_size=500)

        # Bulk PermissionMapper update
        permission_mappers_to_create = []
        existing_mappers = {
            p.employee.email: p for p in PermissionMapper.objects.filter(
                service=self.service, employee__email__in=existing_emails
            )
        }

        for user in wordpress_users:
            email = user['user_email']
            employee = existing_employees.get(email) or next(
                (e for e in employees_to_create if e.email == email), None
            )

            if email not in existing_mappers and employee:
                permission_mappers_to_create.append(
                    PermissionMapper(employee=employee, service=self.service, active=True)
                )
            else:
                mapper = existing_mappers.get(email)
                if mapper:
                    mapper.active = True
                    mapper.deactivate_time = None

        with transaction.atomic():
            if permission_mappers_to_create:
                PermissionMapper.objects.bulk_create(permission_mappers_to_create, batch_size=500)

            if existing_mappers:
                PermissionMapper.objects.bulk_update(
                    existing_mappers.values(),
                    ['active', 'deactivate_time'],
                    batch_size=500
                )

    except Exception as e:
        logger.error(
            f"Error syncing users for service {self.service_name}: {e}",
            exc_info=True
        )
        raise
